language: go

go:
  - "1.16"

addons:
  apt:
    chrome: stable

env:
  global:
    - GOLANG_VERSION="${TRAVIS_GO_VERSION}"
    - APP_VERSION="${TRAVIS_TAG:-edge}"

before_install:
  - export CHROMEDP_TEST_RUNNER=google-chrome-stable
  - export CHROMEDP_DISABLE_GPU=true
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - make get
  - go get github.com/mattn/goveralls

script:
  - make test
<<<<<<< HEAD
  - $GOPATH/bin/goveralls -service=travis-ci -coverprofile=coverage.out
  - make GOLANG_VERSION="${GOLANG_VERSION%.x}" APP_VERSION="${APP_VERSION}" DOCKER_IMAGE="${DOCKER_IMAGE}" image
=======
  - docker build --pull --cache-from "$DOCKER_IMAGE:latest" --build-arg GOLANG_VERSION="${GOLANG_VERSION%.x}" --build-arg LIBVIPS_VERSION="${LIBVIPS}" --build-arg MIM_VERSION="${MIM_VERSION}" --tag "$DOCKER_IMAGE:${MIM_VERSION}" --tag "$DOCKER_IMAGE:latest" -f docker/Dockerfile .
  - docker push "$DOCKER_IMAGE:${MIM_VERSION}"
  - docker push "$DOCKER_IMAGE:latest"
>>>>>>> 363ee5406fabd8f7105bf077fcd3aaff9390ecff

after_success:
  - $GOPATH/bin/goveralls -service=travis-ci -coverprofile=coverage.out

notifications:
  email: true